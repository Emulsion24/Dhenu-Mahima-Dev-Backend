generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//////////////////////////////
// USERS & AUTHENTICATION
//////////////////////////////

model User {
  id         Int       @id @default(autoincrement())
  name       String
  email      String    @unique
  password   String?  
  image      String?
  address    String?
  phone      String?
  otpCode           String?
  otpExpires        DateTime?
  resetToken        String?
  resetTokenExpires DateTime?
  isVerified        Boolean   @default(false)
  role       String    @default("user") // user | subadmin | admin
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt


  bookOrders    BookOrder[]
  bookPurchases BookPurchase[]
  donations  Donation[]
  payments   Payment[]
}




//////////////////////////////
// DONATIONS
//////////////////////////////

model Donation {
  id            Int      @id @default(autoincrement())
  userId        Int?
  email         String?
  pan           String?
  name          String?
  amount        Float
  status        String   @default("pending") // pending | success | failed
  paymentMethod String? // phonepe | stripe | etc.
  transactionId String  @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])
}

//////////////////////////////
// PDF BOOKS & ORDERS
//////////////////////////////

// Book Model - Stores PDF book information
model Book {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  author      String   @db.VarChar(255)
  fileName    String   @db.VarChar(255)   // Stored PDF filename
  filePath    String   @db.VarChar(500)   // Server path to PDF
  fileSize    String   @db.VarChar(50)    // e.g., "2.5 MB"
  price       Float    @db.Double
  description String?  @db.Text
  coverImage  String?  @db.VarChar(255)   // Cover image filename
  uploadDate  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases   BookPurchase[]
  orderItems  BookOrderItem[]

  @@map("books")
  @@index([name])
  @@index([author])
}

// Coupon Model - Discount codes
model BookCoupon {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(50)
  discount    Float    @db.Double
  type        String   @db.VarChar(20)    // "PERCENTAGE" or "FIXED"
  description String?  @db.Text
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders BookOrder[]

  @@map("book_coupons")
  @@index([code])
  @@index([active])
}

// Order Model - Payment orders
model BookOrder {
  id              Int      @id @default(autoincrement())
  userId          Int
  totalAmount     Float    @db.Double
  discountAmount  Float    @default(0) @db.Double
  finalAmount     Float    @db.Double
  couponId        Int?
  paymentId       String?  @db.VarChar(255)  // Razorpay payment ID
  orderId         String?  @db.VarChar(255)  // Razorpay order ID
  status          String   @default("PENDING") @db.VarChar(20) // PENDING | COMPLETED | FAILED | REFUNDED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon    BookCoupon?     @relation(fields: [couponId], references: [id], onDelete: SetNull)
  items     BookOrderItem[]
  purchases BookPurchase[]

  @@map("book_orders")
  @@index([userId])
  @@index([status])
  @@index([orderId])
}

// Order Items - Books in each order
model BookOrderItem {
  id       Int   @id @default(autoincrement())
  orderId  Int
  bookId   Int
  price    Float @db.Double

  order BookOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  book  Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@map("book_order_items")
  @@index([orderId])
  @@index([bookId])
}

// Purchase Model - User's purchased books (Access Control)
model BookPurchase {
  id            Int      @id @default(autoincrement())
  userId        Int
  bookId        Int
  orderId       Int
  purchaseDate  DateTime @default(now())
  accessGranted Boolean  @default(true)

  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  book  Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  order BookOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@map("book_purchases")
  @@index([userId])
  @@index([bookId])
  @@index([accessGranted])
}


//////////////////////////////
// PAYMENT LOGS
//////////////////////////////


//////////////////////////////
// NEWS
//////////////////////////////

model News {
  id          Int           @id @default(autoincrement())
  title       String
  titleEn     String
  slug        String        @unique
  excerpt     String
  image       String
  category    String
  date        String
  readTime    String
  views       Int           @default(0)
  featured    Boolean       @default(false)
  content     Json
  tags        Json
  author      String       
  authorId    Int?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([category])
  @@index([featured])
  @@index([slug])
}



//////////////////////////////
// GOPAL PARIWAR
//////////////////////////////

model GopalPariwar {
  id                  Int      @id @default(autoincrement())
  heroImage           String
  heroTitle           String
  heroSubtitle        String
  personalInfo        Json
  spiritualEducation  String?
  socialLinks         Json?
  lifeJourney         Json
  responsibilities    Json
  pledges             Json
  order               Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

//////////////////////////////
// GAUSHALA
//////////////////////////////

model Gaushala {
  id             Int      @id @default(autoincrement())
  name           String
  photo          String?
  address        String
  establishmentYear String
  contactDetails String
  totalCows      Int
  capacity       Int
  description    String?
  city           String
  state          String
  pincode        String
  contactPerson  String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
//////////////////////////////
// CARDS
//////////////////////////////

model Card {
  id          Int      @id @default(autoincrement())
  title       String   // Hindi title
  titleEn     String?  // English title
  link        String   // URL or internal link
  image       String?  // Optional image for the card
  order       Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
//////////////////////////////
// DATA SANSTHAN / ORGANIZATION
//////////////////////////////

model DtaSanssthan {
  id          Int      @id @default(autoincrement())
  name        String
  person    String?
  image       String?   // optional logo or representative image
  description String?
  email       String?
  phone       String?
  altPhone    String?
  website     String?
  timing      String?   // working hours / schedule
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
//////////////////////////////
// PRIVACY POLICY
//////////////////////////////

model PrivacyPolicy {
  id          Int       @id @default(autoincrement())
  title       String
  subtitle    String
  lastUpdated DateTime
  sections    Section[]
  contact     Contact   @relation(fields: [contactId], references: [id])
  contactId   Int      @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Section {
  id         Int       @id @default(autoincrement())
  privacyPolicyId Int
  title      String
  content    String    @db.Text
  order      Int
  privacyPolicy PrivacyPolicy @relation(fields: [privacyPolicyId], references: [id])
}

model Contact {
  id         Int       @id @default(autoincrement())
  email      String
  phone      String
  phoneHours String
  address    String    @db.Text
  privacyPolicy PrivacyPolicy?
}
//////////////////////////////
// TERMS AND CONDITIONS
//////////////////////////////

model TermsConditions {
  id          Int                     @id @default(autoincrement())
  title       String
  subtitle    String
  lastUpdated DateTime
  sections    TermsConditionsSection[]
  contact     TermsConditionsContact  @relation(fields: [contactId], references: [id])
  contactId   Int                     @unique
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
}

model TermsConditionsSection {
  id                  Int              @id @default(autoincrement())
  termsConditionsId   Int
  title               String
  content             String           @db.Text
  order               Int
  termsConditions     TermsConditions  @relation(fields: [termsConditionsId], references: [id])
}

model TermsConditionsContact {
  id               Int               @id @default(autoincrement())
  email            String
  phone            String
  phoneHours       String
  address          String            @db.Text
  termsConditions  TermsConditions?
}

//////////////////////////////
// BANNERS
//////////////////////////////

model Banner {
  id       Int    @id @default(autoincrement())
  title     String
  image     String
  active    Boolean  @default(false)
  order     Int
  publicId  String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model Message{
  id Int @id @default(autoincrement())
  info String
  createdAt DateTime @default (now()) 
}



model Foundation {
  id              Int       @id @default(autoincrement())
  name            String
  tagline         String?
  logoUrl         String?   @map("logo_url")
  description     String?   @db.Text
  establishedYear String?   @map("established_year")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdById     Int?      @map("created_by_id")
  updatedById     Int?      @map("updated_by_id")
  order     Int              @default(0)

  stats              FoundationStat[]
  activities         FoundationActivity[]
  objectives         FoundationObjective[]
  contact            FoundationContact?
  media              FoundationMedia[]

  @@map("foundations")
}

model FoundationStat {
  id           Int        @id @default(autoincrement())
  foundationId Int        @map("foundation_id")
  label        String
  value        String
  displayOrder Int        @default(0) @map("display_order")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  foundation   Foundation @relation(fields: [foundationId], references: [id], onDelete: Cascade)

  @@map("foundation_stats")
}

model FoundationActivity {
  id           Int        @id @default(autoincrement())
  foundationId Int        @map("foundation_id")
  activityText String     @map("activity_text") @db.Text
  displayOrder Int        @default(0) @map("display_order")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  foundation   Foundation @relation(fields: [foundationId], references: [id], onDelete: Cascade)

  @@map("foundation_activities")
}

enum ObjectiveType {
  main
  supportive
}

model FoundationObjective {
  id            Int           @id @default(autoincrement())
  foundationId  Int           @map("foundation_id")
  title         String
  description   String?        @db.Text 
  objectiveType ObjectiveType @default(main) @map("objective_type")
  displayOrder  Int           @default(0) @map("display_order")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  foundation    Foundation    @relation(fields: [foundationId], references: [id], onDelete: Cascade)

  @@map("foundation_objectives")
}

model FoundationContact {
  id              Int        @id @default(autoincrement())
  foundationId    Int        @unique @map("foundation_id")
  email           String?
  phone           String?
  address         String?    @db.Text
  website         String?
  socialMediaLinks Json?     @map("social_media_links")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  foundation      Foundation @relation(fields: [foundationId], references: [id], onDelete: Cascade)

  @@map("foundation_contacts")
}

enum UserRole {
  super_admin
  admin
  editor
}



enum MediaType {
  logo
  banner
  gallery
  document
}

model FoundationMedia {
  id           Int        @id @default(autoincrement())
  foundationId Int?       @map("foundation_id")
  fileName     String     @map("file_name")
  filePath     String     @map("file_path")
  fileType     String?    @map("file_type")
  fileSize     Int?       @map("file_size")
  mediaType    MediaType  @default(gallery) @map("media_type")
  altText      String?    @map("alt_text")
  createdAt    DateTime   @default(now()) @map("created_at")

  foundation   Foundation? @relation(fields: [foundationId], references: [id], onDelete: Cascade)

  @@map("foundation_media")
}
model Event {
  id          Int      @id @default(autoincrement())
  title       String
  startDate   DateTime
  endDate     DateTime
  time        String?
  location    String
  duration    String   // e.g., "5 दिवसीय", "1 दिवसीय"
  color       String   @default("from-orange-500 to-red-500")
  liveLinks   Json?  
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([endDate])
}

model Bhajan {
  id          String   @id @default(uuid())
  order     Int              @default(0)
  name        String
  artist      String
  album       String?
  duration    String   @default("0:00")
  imageUrl    String?
  audioUrl    String
  audioPath   String   // Server file path
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([artist])
}

model Category {
  id        Int              @id @default(autoincrement())
  name      String           @unique @db.VarChar(100)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // ✅ One-to-many relation with Gaumatabhajan
  gaumatabhajans   Gaumatabhajan[]

  @@map("categories")
}

model Gaumatabhajan {
  id          String    @id @default(uuid())
  name        String
  artist      String
  album       String?
  duration    String    @default("0:00")
  imageUrl    String?
  audioUrl    String
  audioPath   String
  categoryId  Int
  category    Category  @relation(fields: [categoryId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([name])
  @@index([artist])
  @@index([categoryId])
}


// Main payment/membership model - supports both guest and user payments
model MembershipPayment {
  id                     String   @id @default(uuid()) @db.VarChar(191)
  userId                 Int?     // Optional - NULL for guest payments
  name                   String   @db.VarChar(191)
  email                  String   @db.VarChar(191)
  phone                  String   @db.VarChar(191)
  address                String   @db.VarChar(191)
  city                   String   @db.VarChar(191)
  state                  String   @db.VarChar(191)
  pincode                String   @db.VarChar(191)
  membershipType         String   @db.VarChar(191)
  amount                 Int      // Amount in paise
  status                 String   @default("pending") @db.VarChar(191) // pending, active, failed, cancelled, expired
  
  // Order/Transaction IDs
  transactionId          String   @db.VarChar(191)
  orderId                String?  @db.VarChar(191)
  merchantOrderId        String?  @unique @db.VarChar(191)
  
  // PhonePe Subscription IDs (for AutoPay/recurring)
  merchantSubscriptionId String?  @unique @db.VarChar(191)
  phonePeSubscriptionId  String?  @db.VarChar(191)
  authRequestId          String?  @db.VarChar(191)
  
  // Subscription Details (NULL for one-time payments)
  subscriptionFrequency  String?  @db.VarChar(50) // YEARLY for subscriptions
  recurringCount         Int?     // Number of recurring payments (e.g., 10 years)
  amountType             String?  @db.VarChar(50) // FIXED or VARIABLE
  authWorkflowType       String?  @db.VarChar(50) // TRANSACTION or PENNY_DROP
  
  // Subscription State (NULL for one-time payments)
  subscriptionState      String?  @db.VarChar(50) // CREATED, ACTIVE, PAUSED, CANCELLED, COMPLETED, EXPIRED
  subscriptionStartDate  DateTime?
  subscriptionEndDate    DateTime?
  nextBillingDate        DateTime?
  
  // Payment Details
  paymentMethod          String   @db.VarChar(191) // UPI_COLLECT or UPI_AUTOPAY
  providerReferenceId    String?  @db.VarChar(191)
  payResponseCode        String?  @db.VarChar(191)
  
  // Metadata
  metadata               String?  @db.Text // Store VPA, merchantUserId, etc.
  callbackData           String?  @db.Text
  
  // Timestamps
  createdAt              DateTime @default(now()) @db.DateTime(3)
  updatedAt              DateTime @updatedAt @db.DateTime(3)
  
  // Relations
  recurringPayments      RecurringPayment[]
  
  @@index([orderId])
  @@index([merchantOrderId])
  @@index([merchantSubscriptionId])
  @@index([phonePeSubscriptionId])
  @@index([authRequestId])
  @@index([transactionId])
  @@index([userId, status])
  @@index([email])
  @@index([phone])
  @@index([subscriptionState])
  @@index([nextBillingDate])
  @@index([paymentMethod])
  @@map("membershipPayment")
}

// Track recurring payments (yearly renewals)
model RecurringPayment {
  id                     String   @id @default(uuid()) @db.VarChar(191)
  membershipPaymentId    String   @db.VarChar(191)
  
  // Redemption IDs
  merchantRedemptionId   String   @unique @db.VarChar(191)
  merchantOrderId        String   @db.VarChar(191)
  
  // Amount
  amount                 Int      // Amount in paise
  
  // Status
  status                 String   @db.VarChar(50) // PENDING, SUCCESS, FAILED
  state                  String?  @db.VarChar(50) // ACCEPTED, COMPLETED, FAILED
  
  // PhonePe Details
  providerReferenceId    String?  @db.VarChar(191)
  payResponseCode        String?  @db.VarChar(191)
  
  // Dates
  dueDate                DateTime
  notifiedAt             DateTime? // When notify API was called (7 days before)
  executedAt             DateTime? // When redeem API was called
  completedAt            DateTime?
  
  // Metadata
  callbackData           String?  @db.Text
  metadata               String?  @db.Text
  
  createdAt              DateTime @default(now()) @db.DateTime(3)
  updatedAt              DateTime @updatedAt @db.DateTime(3)
  
  // Relations
  membershipPayment      MembershipPayment @relation(fields: [membershipPaymentId], references: [id], onDelete: Cascade)
  
  @@index([membershipPaymentId])
  @@index([merchantRedemptionId])
  @@index([merchantOrderId])
  @@index([status])
  @@index([dueDate])
  @@map("recurringPayment")
}

// General payment tracking
model Payment {
  id          String   @id @default(uuid()) @db.VarChar(191)
  userId      Int?     // Optional - NULL for guest payments
  referenceId String   @db.VarChar(191) // Links to merchantOrderId or merchantSubscriptionId
  provider    String   @db.VarChar(191) // PHONEPE
  amount      Float    // Amount in rupees
  status      String   @db.VarChar(191) // pending, success, failed
  type        String?  @db.VarChar(50) // 'subscription_setup', 'recurring_payment', 'one_time'
  metadata    String?  @db.Text
  createdAt   DateTime @default(now()) @db.DateTime(3)
  updatedAt   DateTime @updatedAt @db.DateTime(3)
  
  @@index([userId])
  @@index([referenceId])
  @@index([provider])
  @@index([type])
  @@index([status])
  @@map("payment")
  
  user User? @relation(fields: [userId], references: [id])
}